name: Deploy AKS Cluster with Terraform and Storage Check

on:
  push:
    branches:
      - my-artificial-client-02
    paths:
      - k8s/**

env:
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  #azure_credentials: ${{ secrets.JSON_CREDENTIALS_AZURE_ITSAJ_AUT }}
  
  # Parametry Storage Account dla Terraform State
  TF_STORAGE_ACCOUNT_NAME: "itsajtfstatestorage"
  TF_CONTAINER_NAME: "tfstate"
  TF_PLAN_CONTAINER_NAME: "tfplan"
  TF_STATE_KEY: "terraform.tfstate"
  TF_STATE_RESOURCE_GROUP: "terraform-state-rg"
  TF_STATE_REGION: "westeurope"

  # na rzecz deploymentu TF
  $AKS_RESOURCE_GROUP: "my-resource-group"
  $AKS_CLUSTER_NAME: "my-aks-cluster"

jobs:
  deploy-k8s-manifest:
    name: Deploy Kubernetes Manifest
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          # ref: my-artificial-client-03
          sparse-checkout: |
            k8s
      
      - name: Sprawdzenie katalogu czy sÄ… manifesty
        run: ls -al && ls -al ./k8s

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.CREDENTIALS_AZURE_ITSAJ_AUT }}

      - name: Set up Kubectl
        run: az aks install-cli

      - name: Get AKS Credentials
        run: az aks get-credentials --name my-aks-cluster --overwrite-existing --resource-group my-resource-group
        # az aks get-credentials --name $AKS_CLUSTER_NAME --overwrite-existing --resource-group $AKS_RESOURCE_GROUP 
         

      - name: Deploy Kubernetes Manifest
        run: |
          kubectl get nodes
          kubectl apply -f ./k8s/pod.yaml
          kubectl get pod

      - name: Test Kubernetes Manifest
        run: |
          kubectl get pod -n default
